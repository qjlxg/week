name: ğŸ”„ æè‡´é‡åŒ–ç³»ç»Ÿ

on:
  workflow_dispatch:
  push:
    paths:
      - 'stock_scanner_go.py'
      - '.github/workflows/stock_scanner_go.yml'
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 18:00 è¿è¡Œ

permissions:
  contents: write

jobs:
  run_scanner_and_backtest:
    timeout-minutes: 60 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          pip install akshare pandas pytz numpy tabulate

      - name: ğŸš€ è¿è¡Œæé€Ÿé‡åŒ–å¼•æ“
        run: |
          mkdir -p stock_data
          mkdir -p results
          python stock_scanner_go.py

      - name: ğŸ’¾ è‡ªåŠ¨åŒæ­¥å¹¶æäº¤ç»“æœ (.md & .csv)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --global core.quotepath false
          
          # 1. æš‚å­˜æ‰€æœ‰ç»“æœï¼ˆåŒ…æ‹¬ md æŠ¥å‘Šå’Œå¯èƒ½çš„ csv/txtï¼‰
          git add results/*.md
          git add results/*.csv || echo "No CSV files"
          git add backtest_result.txt || echo "No backtest file"
          
          git stash
          
          # 2. åŒæ­¥è¿œç¨‹ä»“é˜²æ­¢æ¨é€å†²çª
          git pull origin ${{ github.ref_name }} --rebase
          
          # 3. é‡Šæ”¾æš‚å­˜çš„ç»“æœ
          git stash pop || echo "No changes to pop"
          
          # 4. é‡æ–°æ·»åŠ å¹¶æ£€æŸ¥å˜åŠ¨
          git add results/*.md
          git add results/*.csv || echo "No CSV files"
          git add backtest_result.txt || echo "No backtest file"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… å‘ç°æŠ¥å‘Šæ›´æ–°ï¼Œå‡†å¤‡æ¨é€..."
            git commit -m "ğŸ¤– æè‡´ç­–ç•¥è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d %H:%M')"
            git push origin ${{ github.ref_name }}
          else
            echo "âšª æ²¡æœ‰å‘ç°æ ‡çš„å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
